# cpu 分析

* 执行 demo
`go run cmd/demo2/main.go`

* 以 web 页面查看生成的 pprof 文件
`go tool pprof -http=:8081 cpu.prof`

## VIEW

### 1. Top 页面

* 显示消耗资源最多的函数列表
* 按照 flat 或 cum 排序
* 可以看到每个函数的 CPU 使用百分比

#### Flat(平坦值): 识别自身逻辑复杂度高的函数

* 含义：函数自身执行所消耗的资源量，不包括它调用的其他函数消耗的资源
* 单位：根据分析类型不同而异
    * CPU 分析时：通常是时间（毫秒、秒）
    * 内存分析时：通常是字节数
    * 锁分析时：通常是纳秒或阻塞时间
* 特点：只计算函数本身的代码执行消耗，不包含调用其他函数的时间

##### 实际应用

高 Flat 值函数,这些函数本身的代码执行效率有问题,可能包含复杂计算、密集循环或低效算法

#### Flat（平坦百分比）: 直观表示函数对资源消耗的相对贡献度

* 含义：函数自身执行消耗占总资源消耗的百分比
* 计算方式：(函数的Flat值 ÷ 所有函数的Flat值总和) × 100%
* 范围：0% 到 100%
* 特点：百分比形式使不同规模的分析结果可比较

##### 实际应用

高 %Flat 函数：这些是最值得优化的目标，因为它们自身消耗了大部分资源

例如，如果一个函数的 %Flat 是 40%，优化它可能会显著提升整体性能
优化策略：
通常应优先考虑 %Flat 高的函数
查看具体函数实现，寻找优化空间，如改进算法复杂度、减少循环次数等

与 Cum 对比：

**Flat 高但 Cum 不高的函数：这些是"叶子节点"函数，自身有优化空间**
**Flat 低但 Cum 高的函数：这些函数可能是调用其他耗时函数的"路由"函数**


#### Cum（累积值）: 识别整个调用树中消耗资源最多的入口点

* 含义：函数自身执行消耗加上它调用的所有函数消耗的资源总量
* 单位：与 Flat 相同，根据分析类型不同而异
* CPU 分析时：通常是时间（毫秒、秒）
* 内存分析时：通常是字节数
* 锁分析时：通常是纳秒或阻塞时间
* 特点：包含函数本身及其调用链中所有子函数的资源消耗
* Cum >> Flat：函数自身消耗少，但调用了其他消耗大的函数
* Cum ≈ Flat：函数主要消耗在自身代码中，很少调用其他函数
* 识别 Cum 高但 Flat 低的函数，它们是调用链的"路由点"

#### %Cum（累积百分比）: 找出最重要的函数调用链和调用入口点

* 含义：函数及其调用的所有函数消耗占总资源消耗的百分比
* 计算方式：(函数的Cum值 ÷ 所有函数的Flat值总和) × 100%
* 范围：0% 到 100%（主函数通常接近 100%）
* 特点：反映了以该函数为入口点的调用树占用的总体资源比例

##### 实际应用

* 表示该函数及其调用链占用了总体消耗的大部分
* 优化这些函数及其子函数可能带来显著性能提升
* 主函数 main 的 %Cum 通常接近 100%

##### 优化策略：
关注 %Cum 高的函数，挖掘其调用链
沿着调用链找到 Flat 值高的"热点"函数
先优化 Flat 高的底层函数，再考虑调整调用结构


#### Sum%（累计百分比）

* Sum% 是一个累计百分比值，表示从表格顶部到当前行的所有条目的累计贡献
* 它是按照从高到低排序的各行百分比的累加和
* 显示了到目前为止已经"解释"了多少百分比的总资源使用量

##### 具体解释

* 第一行的 Sum% 就等于该行的百分比值
* 第二行的 Sum% 是第一行和第二行百分比的总和
* 依此类推，每一行的 Sum% 都是当前行及其上方所有行的百分比总和
* 最底部行的 Sum% 应该接近或等于 100%

##### 实用价值: 快速识别最重要的几个函数

例如，如果前5个函数的 Sum% 达到了90%，表明这5个函数占用了绝大部分资源。

优化时可以关注 Sum% 较低(如80%以内)的函数集合，这样能获得最大的优化收益

可以用来确定"二八法则"(帕累托法则)是否适用于您的代码

### 2. Graph 页面: 图形化展示函数调用关系

* 每个节点代表一个函数,节点大小表示资源消耗
* 每个节点上显示的数据包括：函数名称、Flat 值、Cum 值等
* 红色表示热点函数
* 箭头表示调用关系
* 边的粗细：表示调用频率或权重
* 边上的数字：调用次数或消耗的资源量

#### 关注点

* 红色节点：资源消耗最多的热点函数，红色越深，消耗资源越多
* 大节点：尺寸通常表示累积资源消耗(大而不红的节点也值得关注)

### 3. Flame Graph 页面

水平方向：表示资源消耗的比例
垂直方向：调用栈深度，底部是调用者，顶部是被调用者
颜色：为了区分不同函数，不表示性能差异

#### 关注点

* 宽矩形
* 深而窄的"塔"：表示深层递归或长调用链
* 宽而浅的"平台"：表示单个函数消耗了大量资源
* 参差不齐的"山脉"：表示多个不同的调用路径

### 4. Peek 页面
可以查看具体函数的源代码
高亮显示热点行
显示每行代码的资源消耗

### 5. Source 页面
类似于 Peek，但提供了更多上下文
显示函数在源文件中的位置

### 6. 分析建议

* 首先关注 cum 最高的函数，了解哪些调用链耗时最多
* 然后查看 flat 最高的函数，这些是实际的性能瓶颈
* 在 Graph 页面查看调用关系，理解代码执行流程
* 使用 Flame Graph 找到最宽的函数块，这些是占用资源最多的地方
* 在 Source/Peek 页面查看具体代码，了解耗时操作的具体位置

## SAMPLE 页面

### samples（采样数）

* 表示在采样期间这个函数被记录的次数
* 每个样本代表性能分析器在特定时间点对程序状态的一次捕获
* 样本数越多，表示该函数在执行过程中被观察到的频率越高
* 这是一个绝对值，表示原始的采样命中次数

### cpu（CPU 时间）

* 表示该函数消耗的估计 CPU 时间，通常以毫秒(ms)或秒(s)为单位
* 这是根据采样数和采样频率计算出来的时间估计值
* 例如，如果采样频率是 100Hz（每秒采样100次），那么每个样本大约代表 10ms 的 CPU 时间
* 反映了函数实际消耗的处理器时间

### 两者关系

* cpu 值通常是从 samples 计算得出的
* cpu = samples × (采样周期)
* 例如，如果默认采样频率是 100Hz，那么 cpu ≈ samples × 0.01s

### 分析建议

* samples 高的函数是程序执行中的"热点"
* 优化时应该优先考虑 cpu 值高的函数，因为它们实际消耗了更多的处理器时间
* 这两个指标结合使用，可以帮助确定哪些函数最需要优化


## REFINE: 筛选功能

### Focus（聚焦）

功能：限制显示只包含匹配特定模式的函数
用法：输入函数名、包名或正则表达式
效果：只显示匹配项及其相关的调用链
适用场景：当您想专注分析特定函数或包时
例子：输入 matrix 将只显示包含该字符串的函数及其调用关系

### Ignore（忽略）

功能：从视图中排除匹配特定模式的函数
用法：输入函数名、包名或正则表达式
效果：隐藏所有匹配项及其独有的调用链
适用场景：排除标准库或不需要关注的代码
例子：输入 ^runtime\. 将隐藏所有 runtime 包中的函数
